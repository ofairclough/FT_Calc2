<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Job Title Lookup & Salary Calculation</title>

  <!-- Load jQuery first -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  
  <!-- Load jQuery UI -->
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css" />

  <!-- Load Bootstrap CSS and JS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Update Font Awesome to the latest version -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>

     /* L79 CSS customizations of bootstrap*/
    /* Custom Font: Poppins */
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

    body {
      font-family: 'Poppins', Arial, sans-serif;
      padding: 20px;
    }


     /* L79 CSS customizations of bootstrap*/




     
     .banner-79 {
                    text-align: center;
                    padding: 10px;
                }

                .banner-79 h2 {
                    font-weight: 900; /* Extra bold */
                    color: #09152d;
                    display: inline-block; /* Make the background wrap tightly around the text */
                    background-color: yellow; /* Highlight effect */
                    padding: 0 5px; /* Add some padding for the highlight */
                }
      /* L79 CSS customizations of bootstrap*/          
    .autocomplete-container {
      max-width: 100%;
    }
    .ui-autocomplete {
      max-height: 300px;
      overflow-y: auto;
      overflow-x: hidden;
      background: white;
      border: 1px solid #ccc;
    }
    .hidden {
      display: none;
    }
    .highlighted {
      background-color: #ffff99;
    }
    .you-are-here {
      display: block;
      margin-top: 5px;
      font-size: 0.9em;
      color: #ff0000;
    }
    .previous-year {
      background-color: #f0f8ff; /* Light blue background for 2024 */
    }
    @media (max-width: 576px) {
      body {
        padding: 10px;
      }
      h2 {
        font-size: 1.5rem;
      }
      .form-label {
        font-size: 0.9rem;
      }
      .form-select-lg, .form-control-lg {
        font-size: 0.9rem;
        padding: 0.5rem;
      }
      #calculate-salary, #reset-form {
        font-size: 0.9rem;
        padding: 0.5rem 1rem;
      }
      #salary-display {
        font-size: 1rem;
      }
      table {
        font-size: 0.8rem;
      }
    }
    /* Highlight diagonal progression */
    .diagonal-highlight {
      background-color: #d4edda !important; /* Light green background */
      animation: diagonal-highlight-fade 1s ease-in-out;
    }

    @keyframes diagonal-highlight-fade {
      from {
        background-color: #c3e6cb;
      }
      to {
        background-color: #d4edda;
      }
    }

    /* Highlight the 2028 max salary cell */
    .max-salary-highlight {
      background-color: #098600 !important; /* High-value green */
      color: white !important;
      font-weight: bold;
    }

    /* Disable jQuery UI tooltip styling */
    .ui-tooltip {
      display: none !important;
    }

    /* Ensure Bootstrap tooltip styling is applied */
    .tooltip {
      font-size: 0.875rem; /* Match Bootstrap's default font size */
      background-color: #000; /* Match Bootstrap's default background color */
      color: #fff; /* Match Bootstrap's default text color */
      border-radius: 0.25rem; /* Match Bootstrap's default border radius */
      padding: 0.5rem; /* Match Bootstrap's default padding */
    }

    .tooltip-arrow {
      border-color: #000 !important; /* Match Bootstrap's default arrow color */
    }
    #salary-display {
      font-size: 1rem !important; /* Override Bootstrap's fs-4 class */
    }

    /* Smaller Font Awesome Icon for Increases */
    .fa-circle-arrow-up {
      font-size: 0.8em; /* Slightly smaller size */
    }
  </style>
</head>

<body class="container">
  <div class="row justify-content-center">
    <div class="banner-79 col-md-8 col-sm-12">
      <h2 class="banner-79 text-center mt-4 ">CUPE Local 79</h2>

      <div class="mb-3">
        <label for="employment-type" class="form-label">Select Employment Type:</label>
        <select id="employment-type" class="form-select form-select-lg" data-bs-toggle="tooltip" title="Choose your employment type">
          <option value="" selected disabled>-- Select Employment Type --</option>
          <option value="full-time">Full Time</option>
          <option value="part-time">Part Time</option>
        </select>
      </div>

      <div class="autocomplete-container mb-3">
        <label for="job-title" class="form-label">Select a Job Title:</label>
        <input id="job-title" type="text" class="form-control form-control-lg" placeholder="Start typing..." data-bs-toggle="tooltip" title="Type to search for a job title" />
      </div>

      <div class="mb-3" id="full-time-hours" style="display:none;">
        <label for="hoursSelect" class="form-label">Select Hours:</label>
        <select id="hoursSelect" class="form-select form-select-lg" data-bs-toggle="tooltip" title="Select weekly hours">
          <option value="" selected disabled>-- Select Hours --</option>
          <option value="35">35</option>
          <option value="37.5">37.5</option>
          <option value="40">40</option>
        </select>
      </div>

      <div id="part-time-hours" class="mb-3 hidden">
        <label for="customHours" class="form-label">Enter custom hours:</label>
        <input type="number" id="customHours" class="form-control form-control-lg" data-bs-toggle="tooltip" title="Enter custom weekly hours" />
      </div>

      <div id="hoursDisplay" class="mb-3">
        These calculations are based on the weekly paid hours: 
        <span id="hoursValue" class="badge bg-primary fs-5 ms-2" style="display: inline-block; transition: transform 0.3s ease, background-color 0.3s ease;">--</span>
      </div>

      <div class="mb-3">
        <label for="years-of-service" class="form-label">Select Step:</label>
        <select id="years-of-service" class="form-select form-select-lg" data-bs-toggle="tooltip" title="Choose your step">
          <option value="" selected disabled>-- Select Step --</option>
          <option value="1">Step 1</option>
          <option value="2">Step 2</option>
          <option value="3">Step 3</option>
          <option value="4">Step 4</option>
        </select>
      </div>

      <div class="mt-4 text-center">

        <div class="" role="group">
        <button type="button" id="calculate-salary" class="btn btn-success btn-lg" data-bs-toggle="tooltip" title="Calculate your yearly salary">Calculate  <i class="fa fa-calculator" aria-hidden="true"></i></button>
        
        <button type="button" id="reset-form" class="btn btn-secondary btn-lg" data-bs-toggle="tooltip" title="Click to reset the form">Reset <i class="fa fa-refresh" aria-hidden="true"></i></button>
        </div>
        
      </div>
        </div>
        
        </div>
      </div>
        <div id="salary-display" class="mt-3" aria-live="polite"></div>
      
      </div>
    </div>
  </div>
  <div id="wage-table-container" class="mt-4" style="display:none;">
    <h4 class="text-center"> <span id="wage-grade" class="badge bg-secondary"></span></h4>
    <div class="table-responsive">
      <table class="table table-bordered table-striped">
        <thead class="table-dark">
            <tr>
                <th class="table-dark">Year</th>
                <th class="text-center">Step 1</th>
                <th class="text-center">Step 2</th>
                <th class="text-center">Step 3</th>
                <th class="text-center">Step 4</th>
                <th>Annual Earnings <i class="fa-solid fa-sack-dollar"></i></th>
            </tr>
        </thead>
        <tbody>
        </tbody>
        <tfoot>
          <tr>
            <td colspan="6" class="text-end">
              <button id="toggle-weekly-earnings" class="btn btn-dark btn-sm" data-bs-toggle="tooltip" title="Toggle Yearly/Weekly Earnings">
                <i class="fa-solid fa-calendar"></i> Toggle Weekly
              </button>

              <script>
                $(document).ready(function () {
                  let isWeekly = false;

                    $("#toggle-weekly-earnings").on("click", function () {
                    const table = $("#wage-table-container table");
                    const header = table.find("thead th:last-child");
                    const rows = table.find("tbody tr");

                    if (!isWeekly) {
                      // Change header text to Weekly Earnings (retain icon and formatting)
                      header.html('Weekly Earnings <i class="fa-solid fa-sack-dollar"></i>');

                      // Update each row's last column to show weekly earnings
                      rows.each(function () {
                      const annualCell = $(this).find("td:last-child");
                      const annualValue = parseFloat(annualCell.text().replace(/[^0-9,.-]+/g, "").replace(/,/g, ""));
                      if (!isNaN(annualValue)) {
                        const weeklyValue = (annualValue / 52).toFixed(2);
                        annualCell.html(formatCurrency(parseFloat(weeklyValue)));
                      }
                      });

                      $(this).html('<i class="fa-solid fa-calendar"></i> Toggle Annual');
                    } else {
                      // Change header text back to Annual Earnings (retain icon and formatting)
                      header.html('Annual Earnings <i class="fa-solid fa-sack-dollar"></i>');

                      // Update each row's last column to show annual earnings
                      rows.each(function () {
                      const weeklyCell = $(this).find("td:last-child");
                      const weeklyValue = parseFloat(weeklyCell.text().replace(/[^0-9,.-]+/g, "").replace(/,/g, ""));
                      if (!isNaN(weeklyValue)) {
                        const annualValue = (weeklyValue * 52).toFixed(2);
                        weeklyCell.html(formatCurrency(parseFloat(annualValue)));
                      }
                      });

                      $(this).html('<i class="fa-solid fa-calendar"></i> Toggle Weekly');
                    }

                    isWeekly = !isWeekly;
                    });

                  function formatCurrency(num) {
                    return `$${num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                  }
                });
              </script>
            </td>
          </tr>
        </tfoot>
      </table>
      <div class="mt-3 text-center"></div>
        <button id="toggle-increases" class="btn btn-info btn-md" data-bs-toggle="tooltip" title="Click to show or hide yearly dollar increases">
          Show <i class="fa-solid fa-dollar-sign"></i> Increases
        </button>
        <button id="toggle-percentage-increases" class="btn btn-warning btn-md" data-bs-toggle="tooltip" title="Click to show or hide percentage increases">
          Show <i class="fa-solid fa-percent"></i> Increases
        </button>
      </div>
    </div>
  </div>

  <script>
    // Ensure formatCurrency is defined at the top
    function formatCurrency(num) {
      return num.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
    }

    let jobWages = {};
    
    // Updated Grid Moves data
    const gridMoves = [
      {
        "Job Title": "MUNICIPAL STANDARDS OFFICER 1",
        "New Wage Grade": 13
      },
      {
        "Job Title": "REGISTERED NURSE LTC",
        "New Wage Grade": 13
      },
      {
        "Job Title": "REGISTERED NURSE PUBLIC HEALTH",
        "New Wage Grade": 13
      },
      {
        "Job Title": "REGISTERED NURSE SSHA",
        "New Wage Grade": 13
      },
      {
        "Job Title": "REGISTERED PRACTICAL NURSE LTC",
        "New Wage Grade": 9
      },
      {
        "Job Title": "REGISTERED PRACTICAL NURSE SSHA",
        "New Wage Grade": 9
      },
      {
        "Job Title": "QUALITY CONTROL OFFICER",
        "New Wage Grade": 9
      },
      {
        "Job Title": "FAMILY SUPPORT WORKER",
        "New Wage Grade": 12
      },
      {
        "Job Title": "HEALTHY ENVIRONMENTS OFFICER",
        "New Wage Grade": 12
      },
      {
        "Job Title": "PUBLIC HEALTH DIETICIAN",
        "New Wage Grade": 13
      }
    ];

    // Updated Market Adjustments data
    const marketAdjustments = [
      {
        "Job Title": "NURSE PRACTITIONER",
        "Adjustment Pre-Across the board January 1, 2025": "$2.50"
      },
      {
        "Job Title": "CALL TAKER PARAMEDIC SERVICES",
        "Adjustment Pre-Across the board January 1, 2025": "15%"
      },
      {
        "Job Title": "CALL TAKER COMMS TRAINING OFFICER",
        "Adjustment Pre-Across the board January 1, 2025": "15%"
      },
      {
        "Job Title": "EMERGENCY MEDICAL DISPATCHER",
        "Adjustment Pre-Across the board January 1, 2025": "15%"
      },
      {
        "Job Title": "COMMUNICATION TRAINING OFFICER",
        "Adjustment Pre-Across the board January 1, 2025": "15%"
      },
      {
        "Job Title": "SENIOR EMERGENCY MEDICAL DISPATCHER",
        "Adjustment Pre-Across the board January 1, 2025": "15%"
      },
      {
        "Job Title": "LAW CLERK",
        "Adjustment Pre-Across the board January 1, 2025": "$1.50"
      },
      {
        "Job Title": "PROSECUTOR 1",
        "Adjustment Pre-Across the board January 1, 2025": "$2.00"
      },
      {
        "Job Title": "PROSECUTOR 2",
        "Adjustment Pre-Across the board January 1, 2025": "$2.00"
      },
      {
        "Job Title": "ASSOCIATE CORPORATE BUYER",
        "Adjustment Pre-Across the board January 1, 2025": "$1.00"
      },
      {
        "Job Title": "CORPORATE BUYER",
        "Adjustment Pre-Across the board January 1, 2025": "$1.00"
      },
      {
        "Job Title": "SENIOR CORPORATE BUYER",
        "Adjustment Pre-Across the board January 1, 2025": "$1.00"
      },
      {
        "Job Title": "SOURCING SPECIALIST",
        "Adjustment Pre-Across the board January 1, 2025": "$1.00"
      },
      {
        "Job Title": "PUBLIC HEALTH NURSE",
        "Adjustment Pre-Across the board January 1, 2025": "$1.00"
      },
      {
        "Job Title": "PUBLIC HEALTH INSPECTOR",
        "Adjustment Pre-Across the board January 1, 2025": "$1.00"
      }
    ];

    $(document).ready(function () {
      // Disable jQuery UI tooltips
      $.widget.bridge('uitooltip', $.ui.tooltip); // Bridge to avoid conflicts
      $.ui.tooltip.prototype.options.disabled = true;

      // Enable Bootstrap tooltips globally using data-bs-* attributes
      $('[data-bs-toggle="tooltip"]').tooltip();

      // Update all tooltip elements to use data-bs-* attributes
      $('[data-toggle="tooltip"]').each(function () {
        $(this).attr('data-bs-toggle', 'tooltip').removeAttr('data-toggle');
      });

      // Fetch job wages from the 2024BaseWages.json file
      $.getJSON("2024BaseWages.json", function (data) {
        jobWages = data;

        // Identify job titles with multiple hour values
        const jobTitleHoursMap = {};
        jobWages.forEach(job => {
          const title = job["JOB TITLE"];
          const hours = job["Hours"];
          if (title) {
            if (!jobTitleHoursMap[title]) {
              jobTitleHoursMap[title] = new Set();
            }
            jobTitleHoursMap[title].add(hours);
          }
        });

        // Prepare autocomplete data
        const jobTitlesWithHours = jobWages
          .filter(job => job["JOB TITLE"]) // Ensure no undefined titles
          .map(job => {
            const title = job["JOB TITLE"];
            const hours = job["Hours"];
            const hasMultipleHours = jobTitleHoursMap[title].size > 1;
            return {
              label: hasMultipleHours ? `${title} (${hours || "N/A"} hours)` : title,
              value: title,
              hours: hours
            };
          });

        $("#job-title").autocomplete({
          source: jobTitlesWithHours,
          minLength: 1,
          delay: 0,
          select: function (event, ui) {
            const selectedJob = ui.item.value;
            const selectedHours = ui.item.hours;
            if ($("#employment-type").val() === "full-time" && selectedHours) {
              $("#hoursSelect").val(selectedHours).trigger("change");
              console.log(`Selected Hours: ${selectedHours}`);
              $("#hoursDisplay .HoursShow").text(selectedHours);
            }
          }
        });
      });

      function applyMarketAdjustment(jobTitle, wage, step) {
        const adjustment = marketAdjustments.find(adj => adj["Job Title"] === jobTitle);
        if (!adjustment) return wage;

        if (adjustment["Adjustment Pre-Across the board January 1, 2025"].includes("%")) {
          const percentage = parseFloat(adjustment["Adjustment Pre-Across the board January 1, 2025"].replace("%", ""));
          return wage * (1 + percentage / 100);
        } else {
          const dollarIncrease = parseFloat(adjustment["Adjustment Pre-Across the board January 1, 2025"].replace("$", ""));
          return wage + dollarIncrease;
        }
      }

      function applyGridMove(jobTitle, wageGrade, step) {
        const gridMove = gridMoves.find(move => move["Job Title"] === jobTitle);
        if (!gridMove) return { wageGrade, wage: null };

        const newWageGrade = parseInt(gridMove["New Wage Grade"]);
        const oldWageGrade = wageGrade;

        // Update the table heading to reflect the wage grade change
        $("#wage-grade").html(`Wage Grade: ${oldWageGrade} <i class="fa-solid fa-circle-right"></i> ${newWageGrade}*`);

        //alert('Upgraded to wage grade ' + newWageGrade + '!');
        const newWageData = jobWages.find(job => job["Wage Grade"] === newWageGrade);
        if (!newWageData || !newWageData[step]) {
          console.error(`No wage data found for grade ${newWageGrade} and step ${step}`);
          return { wageGrade: newWageGrade, wage: null };
        }
        return { wageGrade: newWageGrade, wage: parseFloat(newWageData[step].replace("$", "")) };
      }

      function calculateWageForYear(baseWage, wageGrade, year, step, jobTitle) {
        let wage = baseWage;
      
        if (year === 2025) {
          // Apply Grid Move
          const { wageGrade: newWageGrade, wage: newWage } = applyGridMove(jobTitle, wageGrade, step);
          wageGrade = newWageGrade;
          if (newWage !== null) wage = newWage;
      
          // Apply Market Adjustment
          wage = applyMarketAdjustment(jobTitle, wage, step);
      
          // Apply General Adjustment
            if (wageGrade <= 8) {
            wage += 1.65; // $1.65 for wage grades 1-8
            }  else if (wageGrade === 9) {
              wage += 1.60; // $1.60 for other wage grade 9 jobs
            } 
             else {
            wage *= 1.0395; // 3.95% for wage grades above 9
            }} else if (year === 2026 && jobTitle === "REGISTERED NURSE LTC") {
          console.log("+1 dollar"); // Log the $1 adjustment
          wage += 1; // Apply $1/hour adjustment
          wage *= 1.039; // Apply percentage increase after adjustment
        } else if (year === 2026) {
          wage *= 1.039;
        } else if (year === 2027) {
          wage *= 1.038;
        } else if (year === 2028) {
          wage *= 1.03; // 3% for 2028
        }
      
        return wage;
      }
      
      function updateWageTable(jobTitle, step, hours) {
        const jobData = jobWages.find(job => job["JOB TITLE"] === jobTitle);
        if (!jobData) return;
      
        let tableBody = $("#wage-table-container tbody");
        $("#wage-grade").text(`Wage Grade: ${jobData["Wage Grade"]}`);
      
        let years = ["2024", "2025", "2026", "2027", "2028"];
        let currentYear = "2024";
        tableBody.empty();
      
        let wageGrade = jobData["Wage Grade"];
        let wagesByStep = {};
      
        // Initialize wages for all steps
        for (let i = 1; i <= 4; i++) {
          wagesByStep[i] = parseFloat(jobData[i].replace("$", ""));
        }
      
        years.forEach((year, yearIndex) => {
          let rowClass = year === currentYear ? "highlighted" : year === "2024" ? "previous-year" : "";
          let row = `<tr class="${rowClass}"><td>${year}</td>`;
      
          let currentStep = Math.min(step + Math.max(0, yearIndex - 1), 4); // Progress step each year after 2025, max at Step 4
      
          for (let i = 1; i <= 4; i++) {
            let wageText = wagesByStep[i] ? formatCurrency(wagesByStep[i]) : "-";
            if (i === step && year === currentYear) {
              row += `<td>${wageText} <span class="you-are-here">Current</span></td>`;
            } else if (i === step && year === "2025") {
              row += `<td class="new-highlight" style="font-weight: bold; position: relative;">
                ${wageText}
                <span style="display: block; color: green; font-size: 0.9em;">New</span>
              </td>`;
            } else if (i === currentStep && yearIndex > 1) {
              row += `<td class="diagonal-highlight">${wageText}</td>`;
            } else {
              row += `<td>${wageText}</td>`;
            }
          }
      
          // Corrected annual salary calculation with hourly wage rounding for each year
          let hourlyRate = wagesByStep[currentStep];
          hourlyRate = Math.round(hourlyRate * 100) / 100; // Round hourly rate to 2 decimal places
      
          // Add $1 adjustment for REGISTERED NURSE LTC in 2026 and beyond
          let adjustmentText = "";
          if (jobTitle === "REGISTERED NURSE LTC" && parseInt(year) >= 2026) {
            adjustmentText = `<span style="color: blue; font-size: 0.9em;">
              <i class="fa-solid fa-circle-arrow-up"></i> +$1
            </span>`;
          }
      
          let annualSalary = Math.round((hourlyRate * hours * 52) * 100) / 100; // Calculate and round annual salary to 2 decimal places
          row += `<td>${annualSalary ? formatCurrency(annualSalary) : "-"} ${adjustmentText}</td></tr>`;
          tableBody.append(row);
      
          // Update wages for the next year for all steps
          for (let i = 1; i <= 4; i++) {
            wagesByStep[i] = calculateWageForYear(wagesByStep[i], wageGrade, parseInt(year) + 1, i, jobTitle);
            wagesByStep[i] = Math.round(wagesByStep[i] * 100) / 100; // Ensure hourly rate is rounded for the next year
          }
        });
      
        // Highlight the bottom-right cell (2028 max salary)
        const lastRow = tableBody.find("tr:last-child");
        const lastCell = lastRow.find("td:last-child");
        lastCell.addClass("max-salary-highlight");
      
        $("#wage-table-container").show();
        showYearlyIncreases();
      }
      

      $("#employment-type").on("change", function () {
        const employmentType = $(this).val();
        if (employmentType === "full-time") {
          $("#full-time-hours").removeClass("hidden");
          $("#part-time-hours").addClass("hidden");
          $("#hoursValue").text("--").removeClass("bg-success bg-danger").addClass("bg-primary");
        } else if (employmentType === "part-time") {
          $("#full-time-hours").addClass("hidden");
          $("#part-time-hours").removeClass("hidden");
          const customHours = $("#customHours").val();
          $("#hoursValue").text(customHours || "--").removeClass("bg-success bg-danger").addClass("bg-primary");
        }
      });

      $('#customhours').on('input', function() {
        $('.part-time').text($(this).val());
      });
      $("#calculate-salary").on("click", function () {
        const selectedJob = $("#job-title").val();
        const selectedStep = parseInt($("#years-of-service").val());
        const employmentType = $("#employment-type").val();
        let hours = 0;
      
        if (employmentType === "full-time") {
          hours = parseFloat($("#hoursSelect").val());
        } else if (employmentType === "part-time") {
          hours = parseFloat($("#customHours").val());
        }
      
        // Reset validation classes
        $("#job-title, #years-of-service, #employment-type, #hoursSelect, #customHours").removeClass("is-invalid");
      
        let isValid = true;
      
        // Validate Employment Type
        if (!employmentType) {
          $("#employment-type").addClass("is-invalid");
          isValid = false;
        }
      
        // Validate Job Title
        if (!selectedJob) {
          $("#job-title").addClass("is-invalid");
          isValid = false;
        }
      
        // Validate Step
        if (isNaN(selectedStep)) {
          $("#years-of-service").addClass("is-invalid");
          isValid = false;
        }
      
        // Validate Hours
        if (isNaN(hours) || hours <= 0) {
          if (employmentType === "full-time") {
            $("#hoursSelect").addClass("is-invalid");
          } else if (employmentType === "part-time") {
            $("#customHours").addClass("is-invalid");
          }
          isValid = false;
        }
      
        // If any validation fails, stop further execution
        if (!isValid) {
          $("#salary-display").html("<span class='text-danger'>Please fill out all required fields correctly.</span>");
          return;
        }
      
        // Proceed with salary calculation if all inputs are valid
        updateWageTable(selectedJob, selectedStep, hours);
      
        // Display the calculated salary for the selected step and hours
        const jobData = jobWages.find(job => job["JOB TITLE"] === selectedJob);
        if (jobData && jobData[selectedStep]) {
          const hourlyRate = parseFloat(jobData[selectedStep].replace("$", ""));
          const annualSalary = Math.round(hourlyRate * hours * 52 * 100) / 100; // Round to 2 decimal places
          const nextYearHourlyRate = calculateWageForYear(hourlyRate, jobData["Wage Grade"], 2025, selectedStep, selectedJob);
          const nextYearAnnualSalary = Math.round(nextYearHourlyRate * hours * 52 * 100) / 100; // Calculate next year's annual salary
          const percentageIncrease = ((nextYearHourlyRate - hourlyRate) / hourlyRate * 100).toFixed(2);
          const annualIncrease = Math.round((nextYearAnnualSalary - annualSalary) * 100) / 100; // Calculate annual increase
          $("#salary-display").html(`
            Current salary: <strong>${formatCurrency(annualSalary)}</strong> 
            at Step <strong>${selectedStep}</strong> 
            with an hourly rate of <strong>${formatCurrency(hourlyRate)}</strong>.<br>
            In 2025, your hourly rate will increase by <strong>${percentageIncrease}%</strong>.<br>
            You will make <strong>${formatCurrency(annualIncrease)}</strong> more in 2025.
          `);
        } else {
          $("#salary-display").html("<span class='text-danger'>Unable to calculate salary. Please check your inputs.</span>");
        }
      
        // Scroll to the wage table
        $("html, body").animate({
          scrollTop: $("#wage-table-container").offset().top
        }, 800);
      });
      

      $("#reset-form").on("click", function () {
        // Reset form fields
        $("#employment-type").val("");
        $("#job-title").val("");
        $("#hoursSelect").val("");
        $("#customHours").val("");
        $("#years-of-service").val("");

        // Hide and clear results
        $("#salary-display").empty();
        $("#wage-table-container").hide();
        $("#wage-table-container tbody").empty();

        // Scroll back to the top of the page
        $("html, body").animate({
          scrollTop: 0
        }, 800);

        // Reset tooltips
        $('[data-bs-toggle="tooltip"]').tooltip("hide");
      });

      $("#toggle-increases").on("click", function () {
        const increases = document.querySelectorAll(".increase-text");
        const isHidden = increases[0]?.style.display === "none";

        increases.forEach(increase => {
          increase.style.display = isHidden ? "inline" : "none";
        });

        const buttonText = isHidden ? "Hide $" : "Show $";
        $(this).text(buttonText);
            });

            $("#toggle-percentage-increases").on("click", function () {
        const percentageIncreases = document.querySelectorAll(".percentage-increase-text");
        const isHidden = percentageIncreases[0]?.style.display === "none";

        percentageIncreases.forEach(increase => {
          increase.style.display = isHidden ? "inline" : "none";
        });

        const buttonText = isHidden ? "Hide %" : "Show %";
        $(this).text(buttonText);
      });

      // Call the function to prepare the increases (hidden by default)
      showYearlyIncreases(true);

      // Enable Bootstrap tooltips globally
      $('[data-bs-toggle="tooltip"]').tooltip();
    });

    function showYearlyIncreases() {
      const table = document.querySelector("#wage-table-container table");
      if (!table) {
      console.error("Wage table not found.");
      return;
      }
    
      const rows = table.querySelectorAll("tbody tr");
      rows.forEach((row, rowIndex) => {
      if (rowIndex === 0) return; // Skip the first row (2024 base year)
    
      const prevRow = rows[rowIndex - 1];
      const cells = row.querySelectorAll("td");
      const prevCells = prevRow.querySelectorAll("td");
    
      cells.forEach((cell, cellIndex) => {
        if (cellIndex === 0) return; // Skip the "Year" column
    
        const currentValue = parseFloat(cell.textContent.replace(/[^0-9.-]+/g, ""));
        const prevValue = parseFloat(prevCells[cellIndex].textContent.replace(/[^0-9.-]+/g, ""));
    
        if (!isNaN(currentValue) && !isNaN(prevValue)) {
        const increase = currentValue - prevValue;
        const percentageIncrease = ((increase / prevValue) * 100).toFixed(2);
    
        // Add dollar increase text
        let increaseSpan = cell.querySelector(".increase-text");
        if (!increaseSpan) {
          increaseSpan = document.createElement("span");
          increaseSpan.className = "increase-text";
          increaseSpan.style.color = "green";
          increaseSpan.style.fontSize = "0.9em";
          increaseSpan.style.display = "none";
          cell.appendChild(increaseSpan);
        }
        increaseSpan.innerHTML = ` <i class="fa-solid fa-circle-arrow-up"></i> ${increase.toFixed(2)}`;
    
        // Add percentage increase text
        let percentageSpan = cell.querySelector(".percentage-increase-text");
        if (!percentageSpan) {
          percentageSpan = document.createElement("span");
          percentageSpan.className = "percentage-increase-text";
          percentageSpan.style.color = "orange";
          percentageSpan.style.fontSize = "0.9em";
          percentageSpan.style.display = "none";
          cell.appendChild(percentageSpan);
        }
        percentageSpan.innerHTML = ` <i class="fa-solid fa-circle-arrow-up"></i> ${percentageIncrease}%`;
        }
      });
      });

      // Ensure the bottom-right cell's increase text is visible against the green background
      const lastRow = table.querySelector("tbody tr:last-child");
      if (lastRow) {
      const lastCell = lastRow.querySelector("td:last-child");
      if (lastCell) {
        const increaseSpan = lastCell.querySelector(".increase-text");
        const percentageSpan = lastCell.querySelector(".percentage-increase-text");
        if (increaseSpan) {
        increaseSpan.style.color = "white"; // Set text color to white
        }
        if (percentageSpan) {
        percentageSpan.style.color = "white"; // Set text color to white
        }
      }
      }
    }
   

    

    function highlightProgression(selectedStep) {
      const table = document.querySelector("#wage-table-container table");
      if (!table) {
        console.error("Wage table not found.");
        return;
      }
    
      const rows = table.querySelectorAll("tbody tr");
      let currentWage = 0;
    
      // Get the user's current wage based on the selected step and year
      const currentRow = rows[0]; // 2024 is the base year
      if (currentRow) {
        const currentCells = currentRow.querySelectorAll("td");
        currentWage = parseFloat(currentCells[selectedStep]?.textContent.replace(/[^0-9.-]+/g, "")) || 0;
      }
    
      rows.forEach((row, rowIndex) => {
        const cells = row.querySelectorAll("td");
    
        // Clear previous highlights and tooltips
        cells.forEach(cell => {
          cell.classList.remove("diagonal-highlight");
          cell.removeAttribute("title");
        });
    
        // Highlight progression and add tooltips
        if (rowIndex > 0) {
          let targetCell;
          if (selectedStep + rowIndex - 1 <= 4) {
            // Highlight diagonally until reaching Step 4
            targetCell = cells[Math.min(selectedStep + rowIndex - 1, 4)];
          } else {
            // Once Step 4 is reached, highlight straight down the Step 4 column
            targetCell = cells[4];
          }
    
          if (targetCell) {
            targetCell.classList.add("diagonal-highlight");
    
            // Calculate the increase over the current wage
            const targetWage = parseFloat(targetCell.textContent.replace(/[^0-9.-]+/g, "")) || 0;
            if (currentWage > 0 && targetWage > 0) {
              const dollarIncrease = targetWage - currentWage;
              const percentIncrease = (dollarIncrease / currentWage) * 100;
              targetCell.setAttribute(
                "title",
                `Increase: ${formatCurrency(dollarIncrease)} (${percentIncrease.toFixed(2)}%)`
              );
            }
          }
        }
      });
    }

    function highlight2028MaxSalary() {
      const table = document.querySelector("#wage-table-container table");
      if (!table) {
        console.error("Wage table not found.");
        return;
      }
    
      const rows = table.querySelectorAll("tbody tr");
      if (rows.length === 0) return;
    
      const lastRow = rows[rows.length - 1]; // Get the last row (2028)
      const lastCell = lastRow.querySelector("td:last-child"); // Get the last cell (Annual Salary)
    
      // Get the user's current annual salary
      const firstRow = rows[0]; // 2024 is the base year
      const currentAnnualCell = firstRow.querySelector("td:last-child");
      const currentAnnualSalary = parseFloat(currentAnnualCell?.textContent.replace(/[^0-9.-]+/g, "")) || 0;
    
      if (lastCell && currentAnnualSalary > 0) {
        lastCell.classList.add("max-salary-highlight");
    
        // Calculate the increase over the current annual salary
        const targetAnnualSalary = parseFloat(lastCell.textContent.replace(/[^0-9.-]+/g, "")) || 0;
        const dollarIncrease = targetAnnualSalary - currentAnnualSalary;
        const percentIncrease = (dollarIncrease / currentAnnualSalary) * 100;
    
        lastCell.setAttribute(
          "title",
          `Increase: ${formatCurrency(dollarIncrease)} (${percentIncrease.toFixed(2)}%)`
        );
      }
    }
  </script>

  <script>
    $(document).ready(function () {
      // Ensure Bootstrap tooltips are initialized
      $('[data-bs-toggle="tooltip"]').tooltip();

      // Use MutationObserver to detect DOM changes and reinitialize tooltips
      const observer = new MutationObserver(() => {
        $('[data-bs-toggle="tooltip"]').tooltip();
      });

      // Observe changes in the body element
      observer.observe(document.body, { childList: true, subtree: true });
    });

    // Update hours display dynamically
    $("#employment-type").on("change", function () {
      const employmentType = $(this).val();
      if (employmentType === "full-time") {
        $("#full-time-hours").removeClass("hidden");
        $("#part-time-hours").addClass("hidden");
        $("#hoursValue").text("--").removeClass("bg-success bg-danger").addClass("bg-primary");
      } else if (employmentType === "part-time") {
        $("#full-time-hours").addClass("hidden");
        $("#part-time-hours").removeClass("hidden");
        const customHours = $("#customHours").val();
        $("#hoursValue").text(customHours || "--").removeClass("bg-success bg-danger").addClass("bg-primary");
      }
    });

    $("#hoursSelect").on("change", function () {
      const selectedHours = $(this).val();
      $("#hoursValue").text(selectedHours).removeClass("bg-primary bg-danger").addClass("bg-success");
      animateHoursValue();
    });

    $("#customHours").on("input", function () {
      const customHours = $(this).val();
      $("#hoursValue").text(customHours || "--").removeClass("bg-primary bg-success").addClass("bg-danger");
      animateHoursValue();
    });

    function animateHoursValue() {
      const hoursValue = $("#hoursValue");
      hoursValue.css("transform", "scale(1.2)");
      setTimeout(() => {
        hoursValue.css("transform", "scale(1)");
      }, 300);
    }
  </script>

  <style>
    /* Remove conflicting tooltip styles */
    .tooltip,
    .custom-tooltip {
      display: none !important;
    }
  </style>
</body>
</html>
